<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NG Cites</title>
  <link rel="icon" type="image/png" href="ng_cite.png">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-primary: #e8e8e8;
      --bg-secondary: #fff;
      --bg-tertiary: #fafafa;
      --bg-quaternary: #f7f7f7;
      --bg-history: #f9f9f9;
      --text-primary: #222;
      --text-secondary: #333;
      --text-tertiary: #444;
      --text-muted: #666;
      --text-light: #777;
      --border-primary: #d0d0d0;
      --border-secondary: #ccc;
      --border-tertiary: #ddd;
      --border-accent: #666;
      --button-bg: #fff;
      --button-hover: #f5f5f5;
      --button-active: #e8e8e8;
      --button-primary-bg: #000;
      --button-primary-text: #fff;
      --button-primary-hover: #333;
      --button-primary-active: #555;
      --error-color: #c00;
      --input-bg: #fafafa;
      --input-focus-bg: #fff;
      --batch-bg: #fafafa;
      --batch-item-bg: #fff;
    }

    body.dark-mode {
      --bg-primary: #1a1a1a;
      --bg-secondary: #2a2a2a;
      --bg-tertiary: #222;
      --bg-quaternary: #252525;
      --bg-history: #2d2d2d;
      --text-primary: #e8e8e8;
      --text-secondary: #d0d0d0;
      --text-tertiary: #c0c0c0;
      --text-muted: #999;
      --text-light: #888;
      --border-primary: #444;
      --border-secondary: #3a3a3a;
      --border-tertiary: #333;
      --border-accent: #666;
      --button-bg: #2a2a2a;
      --button-hover: #333;
      --button-active: #3a3a3a;
      --button-primary-bg: #fff;
      --button-primary-text: #000;
      --button-primary-hover: #e8e8e8;
      --button-primary-active: #d0d0d0;
      --error-color: #ff6b6b;
      --input-bg: #222;
      --input-focus-bg: #2a2a2a;
      --batch-bg: #222;
      --batch-item-bg: #2a2a2a;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--bg-primary);
      padding: 30px 15px;
      line-height: 1.5;
      color: var(--text-primary);
      transition: background 0.3s, color 0.3s;
    }

    .container {
      background: var(--bg-secondary);
      padding: 35px;
      max-width: 680px;
      margin: 0 auto;
      border: 1px solid var(--border-primary);
    }

    .theme-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--button-bg);
      border: 1px solid var(--border-secondary);
      padding: 8px 12px;
      cursor: pointer;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 6px;
      z-index: 1000;
    }

    .theme-toggle:hover {
      background: var(--button-hover);
    }

    .github-link {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: var(--button-bg);
      border: 1px solid var(--border-secondary);
      padding: 8px 12px;
      cursor: pointer;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 6px;
      text-decoration: none;
      color: var(--text-primary);
      z-index: 1000;
    }

    .github-link:hover {
      background: var(--button-hover);
    }

    .menu-toggle {
      position: fixed;
      top: 20px;
      left: 20px;
      background: var(--button-bg);
      border: 1px solid var(--border-secondary);
      padding: 8px 12px;
      cursor: pointer;
      font-size: 18px;
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
    }

    .menu-toggle:hover {
      background: var(--button-hover);
    }

    .sidebar {
      position: fixed;
      top: 0;
      left: -320px;
      width: 320px;
      height: 100vh;
      background: var(--bg-secondary);
      border-right: 1px solid var(--border-primary);
      z-index: 1500;
      transition: left 0.3s ease;
      overflow-y: auto;
      padding: 80px 20px 20px 20px;
    }

    .sidebar.open {
      left: 0;
    }

    .sidebar-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.3);
      z-index: 1400;
    }

    .sidebar-overlay.show {
      display: block;
    }

    .sidebar h3 {
      font-size: 18px;
      margin-bottom: 15px;
      color: var(--text-primary);
      font-weight: 600;
    }

    .sidebar .history-item {
      background: var(--bg-history);
      padding: 12px;
      margin-bottom: 10px;
      border-left: 3px solid var(--border-accent);
      font-size: 13px;
      display: block;
    }

    .sidebar .history-content {
      cursor: pointer;
      margin-bottom: 8px;
    }

    .sidebar .history-item small {
      color: var(--text-light);
      display: block;
      margin-top: 5px;
      font-size: 11px;
    }

    .sidebar .history-item button {
      width: 100%;
      margin: 0;
      margin-top: 8px;
    }

    .sidebar .clear-history {
      width: 100%;
      margin-top: 15px;
    }

    .sidebar-empty {
      color: var(--text-muted);
      font-size: 14px;
      text-align: center;
      padding: 20px;
    }


    h1 {
      font-size: 24px;
      margin-bottom: 25px;
      color: var(--text-primary);
      font-weight: 600;
    }

    h2 {
      font-size: 20px;
      margin-bottom: 20px;
      color: var(--text-secondary);
      font-weight: 600;
    }

    .page {
      display: none;
    }

    .active {
      display: block;
    }

    .input-group {
      margin-bottom: 18px;
    }

    label {
      display: block;
      margin-bottom: 6px;
      font-size: 14px;
      color: var(--text-tertiary);
    }

    input, select, textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border-secondary);
      font-size: 14px;
      font-family: inherit;
      background: var(--input-bg);
      color: var(--text-primary);
      transition: border-color 0.2s, background 0.2s;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--border-accent);
      background: var(--input-focus-bg);
    }

    button {
      padding: 11px 20px;
      margin-right: 10px;
      margin-top: 5px;
      cursor: pointer;
      border: 1px solid var(--border-accent);
      background: var(--button-bg);
      font-size: 14px;
      font-family: inherit;
      color: var(--text-primary);
      transition: background 0.2s;
    }

    button:hover {
      background: var(--button-hover);
    }

    button:active {
      background: var(--button-active);
    }

    button.primary {
      background: var(--button-primary-bg);
      color: var(--button-primary-text);
      border-color: var(--button-primary-bg);
    }

    button.primary:hover {
      background: var(--button-primary-hover);
      border-color: var(--button-primary-hover);
    }

    button.primary:active {
      background: var(--button-primary-active);
      border-color: var(--button-primary-active);
    }

    button.delete {
      background: transparent;
      border: 1px solid var(--error-color);
      color: var(--error-color);
      padding: 6px 10px;
      font-size: 12px;
    }

    button.delete:hover {
      background: var(--error-color);
      color: var(--bg-secondary);
    }

    .error {
      color: var(--error-color);
      font-size: 13px;
      margin-top: 5px;
      display: none;
    }

    .error.show {
      display: block;
    }

    pre {
      background: var(--bg-quaternary);
      padding: 15px;
      border: 1px solid var(--border-tertiary);
      white-space: pre-wrap;
      font-size: 13px;
      margin-bottom: 15px;
      font-family: 'Courier New', monospace;
      color: var(--text-primary);
    }

    .history {
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid var(--border-tertiary);
      display: none;
    }

    .history-item {
      background: var(--bg-history);
      padding: 12px;
      margin-bottom: 10px;
      border-left: 3px solid var(--border-accent);
      font-size: 13px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }

    .history-content {
      flex: 1;
      cursor: pointer;
    }

    .history-item small {
      color: var(--text-light);
      display: block;
      margin-top: 5px;
    }

    .clear-history {
      font-size: 13px;
      padding: 8px 14px;
    }

    .nav-buttons {
      margin-top: 20px;
      padding-top: 15px;
      border-top: 1px solid var(--border-tertiary);
    }

    .checkbox-group {
      margin-bottom: 18px;
    }

    .checkbox-group label {
      display: flex;
      align-items: center;
      cursor: pointer;
      color: var(--text-primary);
    }

    .checkbox-group input[type="checkbox"] {
      width: auto;
      margin-right: 8px;
    }

    .batch-area {
      margin-top: 20px;
      padding: 20px;
      background: var(--batch-bg);
      border: 1px solid var(--border-tertiary);
    }

    .batch-item {
      padding: 10px;
      margin-bottom: 10px;
      background: var(--batch-item-bg);
      border: 1px solid var(--border-tertiary);
    }

    .batch-item input {
      margin-bottom: 8px;
    }

    .info-text {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 15px;
    }

    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.show {
      display: flex;
    }

    .modal {
      background: var(--bg-secondary);
      border: 1px solid var(--border-primary);
      padding: 25px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .modal-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 15px;
      color: var(--text-primary);
    }

    .modal-message {
      font-size: 14px;
      margin-bottom: 20px;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    .modal-buttons {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    .modal-buttons button {
      margin: 0;
    }
  </style>
</head>
<body>

  <button class="menu-toggle" id="menuToggle">‚ò∞</button>

  <button class="theme-toggle" id="themeToggle">
    <span id="themeIcon">‚òÄÔ∏è</span>
    <span id="themeText">Light</span>
  </button>

  <a href="https://github.com/Nightbrisk101/NG-Cites" class="github-link" target="_blank" rel="noopener noreferrer">
    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
      <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
    </svg>
    <span>GitHub</span>
  </a>

  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <div class="sidebar" id="sidebar">
    <h3>Citation History</h3>
    <div id="historyContainer"></div>
    <button class="clear-history" id="clearHistoryBtn" style="display: none;">Clear All History</button>
  </div>

  <div class="container">

    <!-- PAGE 1: INPUTS -->
    <div id="page1" class="page active">
      <h1>Newgrounds Citation Generator</h1>
      
      <p class="info-text">Generate properly formatted citations for Newgrounds music tracks</p>

      <div class="checkbox-group">
        <label>
          <input type="checkbox" id="batchMode">
          Batch mode (multiple citations)
        </label>
      </div>

      <div id="singleMode">
        <div class="input-group">
          <label>Song Name *</label>
          <input type="text" id="songName" placeholder="Enter song title">
          <div class="error" id="songError">Song name is required</div>
        </div>

        <div class="input-group">
          <label>Artist/Author *</label>
          <input type="text" id="authorName" placeholder="Enter artist name">
          <div class="error" id="authorError">Author name is required</div>
        </div>

        <div class="input-group">
          <label>Newgrounds Link *</label>
          <input type="text" id="songLink" placeholder="https://www.newgrounds.com/audio/listen/...">
          <div class="error" id="linkError">Valid Newgrounds URL is required</div>
        </div>

        <div class="input-group">
          <label>Publication Date (optional)</label>
          <input type="date" id="pubDate">
        </div>

        <div class="input-group">
          <label>Track ID (optional)</label>
          <input type="text" id="trackId" placeholder="e.g., 123456">
        </div>

        <div class="input-group">
          <label>Duration (optional)</label>
          <input type="text" id="duration" placeholder="e.g., 3:45">
        </div>
      </div>

      <div id="batchMode" style="display: none;">
        <div class="batch-area">
          <h3 style="margin-bottom: 15px; font-size: 16px;">Batch Citations</h3>
          <p class="info-text">Add multiple songs at once. Each song needs at least a title, artist, and link.</p>
          <div id="batchContainer"></div>
          <button onclick="addBatchItem()">Add Another Song</button>
        </div>
      </div>

      <div class="nav-buttons">
        <button class="primary" id="nextBtn">Next</button>
      </div>
    </div>

    <!-- PAGE 2: STYLE SELECTION & PREVIEW -->
    <div id="page2" class="page">
      <h2>Select Citation Style</h2>

      <div class="input-group">
        <label>Citation Format</label>
        <select id="citationStyle">
          <option value="simplified">Simplified</option>
          <option value="mla">MLA (9th Edition)</option>
          <option value="apa">APA (7th Edition)</option>
          <option value="chicago">Chicago</option>
          <option value="harvard">Harvard</option>
          <option value="ieee">IEEE</option>
        </select>
      </div>

      <div class="input-group">
        <h3 style="font-size: 16px; margin-bottom: 10px;">Preview</h3>
        <pre id="previewText">Select a style to see preview</pre>
      </div>

      <div class="nav-buttons">
        <button id="backBtn">Back</button>
        <button class="primary" id="generateBtn">Generate Citation</button>
      </div>
    </div>

    <!-- PAGE 3: OUTPUT -->
    <div id="page3" class="page">
      <h2>Your Citation</h2>
      
      <div id="citationsOutput"></div>

      <div class="nav-buttons">
        <button id="copyBtn">Copy to Clipboard</button>
        <button id="downloadTxtBtn">Download .txt</button>
        <button id="downloadBibBtn">Download .bib</button>
        <button class="primary" id="restartBtn">New Citation</button>
      </div>
    </div>

  </div>

  <div class="modal-overlay" id="modalOverlay">
    <div class="modal">
      <div class="modal-title" id="modalTitle">Alert</div>
      <div class="modal-message" id="modalMessage"></div>
      <div class="modal-buttons" id="modalButtons"></div>
    </div>
  </div>

  <script>
    // Custom alert and confirm functions
    function customAlert(message, title = 'Alert') {
      return new Promise((resolve) => {
        const overlay = document.getElementById('modalOverlay');
        const titleEl = document.getElementById('modalTitle');
        const messageEl = document.getElementById('modalMessage');
        const buttonsEl = document.getElementById('modalButtons');

        titleEl.textContent = title;
        messageEl.textContent = message;
        buttonsEl.innerHTML = '<button class="primary" id="alertOkBtn">OK</button>';

        overlay.classList.add('show');

        document.getElementById('alertOkBtn').onclick = () => {
          overlay.classList.remove('show');
          resolve();
        };

        overlay.onclick = (e) => {
          if (e.target === overlay) {
            overlay.classList.remove('show');
            resolve();
          }
        };
      });
    }

    function customConfirm(message, title = 'Confirm') {
      return new Promise((resolve) => {
        const overlay = document.getElementById('modalOverlay');
        const titleEl = document.getElementById('modalTitle');
        const messageEl = document.getElementById('modalMessage');
        const buttonsEl = document.getElementById('modalButtons');

        titleEl.textContent = title;
        messageEl.textContent = message;
        buttonsEl.innerHTML = `
          <button id="confirmCancelBtn">Cancel</button>
          <button class="primary" id="confirmOkBtn">OK</button>
        `;

        overlay.classList.add('show');

        document.getElementById('confirmOkBtn').onclick = () => {
          overlay.classList.remove('show');
          resolve(true);
        };

        document.getElementById('confirmCancelBtn').onclick = () => {
          overlay.classList.remove('show');
          resolve(false);
        };

        overlay.onclick = (e) => {
          if (e.target === overlay) {
            overlay.classList.remove('show');
            resolve(false);
          }
        };
      });
    }

    let batchItems = [];
    let currentCitations = [];
    let citationHistory = JSON.parse(localStorage.getItem('citationHistory') || '[]');

    // Initialize
    loadHistory();

    // Batch mode toggle
    document.getElementById('batchMode').addEventListener('change', function(e) {
      if (e.target.checked) {
        document.getElementById('singleMode').style.display = 'none';
        document.getElementById('batchMode').style.display = 'block';
        addBatchItem();
        addBatchItem();
      } else {
        document.getElementById('singleMode').style.display = 'block';
        document.getElementById('batchMode').style.display = 'none';
        batchItems = [];
      }
    });

    // Add batch item
    function addBatchItem() {
      const index = batchItems.length;
      const container = document.getElementById('batchContainer');
      
      const div = document.createElement('div');
      div.className = 'batch-item';
      div.innerHTML = `
        <input type="text" placeholder="Song Name" data-index="${index}" data-field="song">
        <input type="text" placeholder="Artist" data-index="${index}" data-field="author">
        <input type="text" placeholder="Newgrounds Link" data-index="${index}" data-field="link">
        <button onclick="removeBatchItem(${index})" style="font-size: 12px; padding: 6px 10px;">Remove</button>
      `;
      
      container.appendChild(div);
      batchItems.push({ song: '', author: '', link: '' });
    }

    // Remove batch item
    function removeBatchItem(index) {
      batchItems.splice(index, 1);
      const container = document.getElementById('batchContainer');
      container.innerHTML = '';
      batchItems.forEach((_, i) => addBatchItem());
    }

    // Update batch items
    document.addEventListener('input', function(e) {
      if (e.target.dataset.index !== undefined) {
        const index = parseInt(e.target.dataset.index);
        const field = e.target.dataset.field;
        if (batchItems[index]) {
          batchItems[index][field] = e.target.value;
        }
      }
    });

    // Page switching
    function showPage(pageId) {
      document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
      document.getElementById(pageId).classList.add("active");
    }

    // Validation
    function validateURL(url) {
      return url.includes('newgrounds.com');
    }

    function validateInputs() {
      let valid = true;
      const errors = ['songError', 'authorError', 'linkError'];
      errors.forEach(id => document.getElementById(id).classList.remove('show'));

      const song = document.getElementById('songName').value.trim();
      const author = document.getElementById('authorName').value.trim();
      const link = document.getElementById('songLink').value.trim();

      if (!song) {
        document.getElementById('songError').classList.add('show');
        valid = false;
      }
      if (!author) {
        document.getElementById('authorError').classList.add('show');
        valid = false;
      }
      if (!link || !validateURL(link)) {
        document.getElementById('linkError').classList.add('show');
        valid = false;
      }

      return valid;
    }

    function validateBatch() {
      return batchItems.every(item => 
        item.song.trim() && item.author.trim() && item.link.trim() && validateURL(item.link)
      );
    }

    // Citation generator
    function generateCitation(style, song, author, link, pubDate, trackId, duration) {
      const today = new Date().toLocaleDateString("en-US", {
        day: "numeric",
        month: "short",
        year: "numeric"
      });

      const yearOnly = pubDate ? new Date(pubDate).getFullYear() : 'n.d.';
      const fullDate = pubDate || today;

      switch(style) {
        case "simplified":
          let simple = `Music: "${song}"\nArtist: ${author}\nLink: ${link}`;
          if (trackId) simple += `\nTrack ID: ${trackId}`;
          if (duration) simple += `\nDuration: ${duration}`;
          return simple;

        case "mla":
          return `${author}. "${song}." *Newgrounds*, ${pubDate ? new Date(pubDate).getFullYear() : 'n.d.'}, ${link}. Accessed ${today}.`;

        case "apa":
          return `${author}. (${yearOnly}). ${song} [Audio]. Newgrounds. ${link}`;

        case "chicago":
          return `${author}. "${song}." Newgrounds. ${link}. Accessed ${today}.`;

        case "harvard":
          return `${author} (${yearOnly}) ${song}. Available at: ${link} (Accessed: ${today}).`;

        case "ieee":
          return `${author}, "${song}," Newgrounds. [Online]. Available: ${link}. [Accessed: ${today}].`;

        default:
          return "Unknown citation style.";
      }
    }

    // Generate BibTeX
    function generateBibTeX(song, author, link, pubDate) {
      const year = pubDate ? new Date(pubDate).getFullYear() : new Date().getFullYear();
      const key = author.split(' ').join('').toLowerCase() + year;
      
      return `@misc{${key},
  author = {${author}},
  title = {${song}},
  year = {${year}},
  howpublished = {\\url{${link}}},
  note = {Newgrounds Audio}
}`;
    }

    // Preview update
    document.getElementById('citationStyle').addEventListener('change', updatePreview);

    function updatePreview() {
      const style = document.getElementById('citationStyle').value;
      const isBatch = document.getElementById('batchMode').checked;
      
      if (isBatch && batchItems.length > 0 && batchItems[0].song) {
        const item = batchItems[0];
        const preview = generateCitation(style, item.song, item.author, item.link);
        document.getElementById('previewText').textContent = preview + '\n\n(Showing preview of first entry)';
      } else if (!isBatch) {
        const song = document.getElementById('songName').value || 'Song Title';
        const author = document.getElementById('authorName').value || 'Artist Name';
        const link = document.getElementById('songLink').value || 'https://newgrounds.com/...';
        const pubDate = document.getElementById('pubDate').value;
        const trackId = document.getElementById('trackId').value;
        const duration = document.getElementById('duration').value;
        
        const preview = generateCitation(style, song, author, link, pubDate, trackId, duration);
        document.getElementById('previewText').textContent = preview;
      }
    }

    // PAGE 1 ‚Üí PAGE 2
    document.getElementById("nextBtn").addEventListener("click", () => {
      const isBatch = document.getElementById('batchMode').checked;
      
      if (isBatch) {
        if (!validateBatch()) {
          customAlert('Please fill in all required fields for each song (Song Name, Artist, and valid Newgrounds link)', 'Validation Error');
          return;
        }
      } else {
        if (!validateInputs()) return;
      }
      
      showPage("page2");
      updatePreview();
    });

    // Back button
    document.getElementById("backBtn").addEventListener("click", () => {
      showPage("page1");
    });

    // PAGE 2 ‚Üí PAGE 3
    document.getElementById("generateBtn").addEventListener("click", () => {
      const style = document.getElementById("citationStyle").value;
      const isBatch = document.getElementById('batchMode').checked;
      
      currentCitations = [];
      const output = document.getElementById('citationsOutput');
      output.innerHTML = '';

      if (isBatch) {
        batchItems.forEach((item, index) => {
          const citation = generateCitation(style, item.song, item.author, item.link);
          currentCitations.push(citation);
          
          const citationDiv = document.createElement('div');
          citationDiv.innerHTML = `<h3 style="font-size: 14px; margin-bottom: 8px; color: #555;">Citation ${index + 1}</h3><pre>${citation}</pre>`;
          output.appendChild(citationDiv);
          
          saveToHistory(item.song, item.author, style, citation);
        });
      } else {
        const song = document.getElementById("songName").value;
        const author = document.getElementById("authorName").value;
        const link = document.getElementById("songLink").value;
        const pubDate = document.getElementById("pubDate").value;
        const trackId = document.getElementById("trackId").value;
        const duration = document.getElementById("duration").value;

        const citation = generateCitation(style, song, author, link, pubDate, trackId, duration);
        currentCitations.push(citation);
        
        output.innerHTML = `<pre>${citation}</pre>`;
        saveToHistory(song, author, style, citation);
      }

      showPage("page3");
      loadHistory();
    });

    // Copy button
    document.getElementById("copyBtn").addEventListener("click", () => {
      const text = currentCitations.join('\n\n');
      navigator.clipboard.writeText(text).then(() => {
        const btn = document.getElementById("copyBtn");
        const originalText = btn.textContent;
        btn.textContent = 'Copied!';
        setTimeout(() => btn.textContent = originalText, 2000);
      });
    });

    // Download TXT
    document.getElementById("downloadTxtBtn").addEventListener("click", () => {
      const text = currentCitations.join('\n\n');
      downloadFile(text, 'citations.txt', 'text/plain');
    });

    // Download BibTeX
    document.getElementById("downloadBibBtn").addEventListener("click", () => {
      const isBatch = document.getElementById('batchMode').checked;
      let bibContent = '';

      if (isBatch) {
        batchItems.forEach(item => {
          bibContent += generateBibTeX(item.song, item.author, item.link) + '\n\n';
        });
      } else {
        const song = document.getElementById("songName").value;
        const author = document.getElementById("authorName").value;
        const link = document.getElementById("songLink").value;
        const pubDate = document.getElementById("pubDate").value;
        
        bibContent = generateBibTeX(song, author, link, pubDate);
      }

      downloadFile(bibContent, 'citations.bib', 'text/plain');
    });

    // Download helper
    function downloadFile(content, filename, type) {
      const blob = new Blob([content], { type });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    // History functions
    function saveToHistory(song, author, style, citation) {
      const entry = {
        song,
        author,
        style,
        citation,
        date: new Date().toLocaleString()
      };
      
      citationHistory.unshift(entry);
      if (citationHistory.length > 20) citationHistory.pop();
      
      localStorage.setItem('citationHistory', JSON.stringify(citationHistory));
    }

    function loadHistory() {
      const container = document.getElementById('historyContainer');
      const clearBtn = document.getElementById('clearHistoryBtn');
      
      container.innerHTML = '';
      
      if (citationHistory.length === 0) {
        container.innerHTML = '<div class="sidebar-empty">No citation history yet</div>';
        clearBtn.style.display = 'none';
        return;
      }
      
      clearBtn.style.display = 'block';
      
      citationHistory.forEach((entry, index) => {
        const div = document.createElement('div');
        div.className = 'history-item';
        div.innerHTML = `
          <div class="history-content">
            <strong>${entry.song}</strong> by ${entry.author}
            <small>${entry.style.toUpperCase()} - ${entry.date}</small>
          </div>
          <button class="delete" onclick="deleteHistoryItem(${index}); event.stopPropagation();">Delete</button>
        `;
        
        // Add click handler to the content div only
        div.querySelector('.history-content').addEventListener('click', () => {
          navigator.clipboard.writeText(entry.citation);
          const originalBg = div.style.background;
          div.style.background = 'var(--button-active)';
          setTimeout(() => div.style.background = originalBg, 500);
        });
        
        container.appendChild(div);
      });
    }

    // Clear history
    document.getElementById("clearHistoryBtn").addEventListener("click", async () => {
      if (await customConfirm('Clear all citation history?', 'Clear History')) {
        citationHistory = [];
        localStorage.removeItem('citationHistory');
        loadHistory();
      }
    });

    // Delete individual history item
    async function deleteHistoryItem(index) {
      if (await customConfirm('Delete this citation from history?', 'Delete Citation')) {
        citationHistory.splice(index, 1);
        localStorage.setItem('citationHistory', JSON.stringify(citationHistory));
        loadHistory();
      }
    }

    // Sidebar toggle functionality
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebarOverlay');
    const menuToggle = document.getElementById('menuToggle');

    menuToggle.addEventListener('click', () => {
      sidebar.classList.add('open');
      sidebarOverlay.classList.add('show');
    });

    sidebarOverlay.addEventListener('click', () => {
      sidebar.classList.remove('open');
      sidebarOverlay.classList.remove('show');
    });

    // Theme toggle functionality
    function initTheme() {
      const savedTheme = localStorage.getItem('theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      
      if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
        document.body.classList.add('dark-mode');
        updateThemeButton(true);
      } else {
        updateThemeButton(false);
      }
    }

    function updateThemeButton(isDark) {
      const icon = document.getElementById('themeIcon');
      const text = document.getElementById('themeText');
      
      if (isDark) {
        icon.textContent = 'üåô';
        text.textContent = 'Dark';
      } else {
        icon.textContent = '‚òÄÔ∏è';
        text.textContent = 'Light';
      }
    }

    document.getElementById('themeToggle').addEventListener('click', () => {
      const isDark = document.body.classList.toggle('dark-mode');
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
      updateThemeButton(isDark);
    });

    // Listen for system theme changes
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
      if (!localStorage.getItem('theme')) {
        if (e.matches) {
          document.body.classList.add('dark-mode');
          updateThemeButton(true);
        } else {
          document.body.classList.remove('dark-mode');
          updateThemeButton(false);
        }
      }
    });

    // Initialize theme on load
    initTheme();

    // Restart
    document.getElementById("restartBtn").addEventListener("click", () => {
      document.getElementById('songName').value = '';
      document.getElementById('authorName').value = '';
      document.getElementById('songLink').value = '';
      document.getElementById('pubDate').value = '';
      document.getElementById('trackId').value = '';
      document.getElementById('duration').value = '';
      document.getElementById('batchMode').checked = false;
      document.getElementById('singleMode').style.display = 'block';
      document.getElementById('batchMode').style.display = 'none';
      batchItems = [];
      document.getElementById('batchContainer').innerHTML = '';
      
      showPage("page1");
    });
  </script>

</body>
</html>